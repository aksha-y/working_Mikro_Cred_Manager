{% extends "base.html" %}

{% block title %}Credentials Created - Mikrotik-Manager{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Success Header -->
            <div class="text-center mb-4">
                <div class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h1 class="h3 text-success mb-2">Credentials Created Successfully!</h1>
                <p class="text-muted">Your temporary MikroTik credentials are ready to use</p>
            </div>

            <!-- Credentials Card -->
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>
                        Temporary Access Credentials
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Security Warning -->
                    <div class="alert alert-warning mb-4">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Important Security Notice
                        </h6>
                        <ul class="mb-0">
                            <li><strong>Save these credentials immediately</strong> - they will not be shown again</li>
                            <li>Credentials will expire automatically in <strong>{{ duration }} minutes</strong></li>
                            <li>Use these credentials only for the stated purpose</li>
                            <li>All activities are logged and monitored</li>
                        </ul>
                    </div>

                    <!-- Device Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Device Information</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>IP Address:</strong>
                                        <span class="text-monospace">{{ wan_ip }}</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Identity:</strong>
                                        <span class="text-monospace">{{ device_identity or 'Unknown' }}</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Purpose:</strong>
                                        <span class="text-muted">{{ purpose }}</span>
                                    </div>
                                    <div>
                                        <strong>Duration:</strong>
                                        <span class="badge bg-info">{{ duration }} minutes</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Expiration Details</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>Created:</strong>
                                        <span id="createdTime">{{ created_at | to_local }}</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Expires:</strong>
                                        <span id="expiresTime" class="text-danger">{{ expires_at | to_local }}</span>
                                    </div>
                                    <div>
                                        <strong>Time Remaining:</strong>
                                        <span id="countdown" class="badge bg-warning"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Credentials -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <strong><i class="fas fa-user me-2"></i>Username</strong>
                            </label>
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control form-control-lg text-monospace" 
                                       id="username" 
                                       value="{{ credentials.username }}" 
                                       readonly>
                                <button class="btn btn-outline-primary" 
                                        onclick="copyToClipboard('username')"
                                        data-bs-toggle="tooltip" 
                                        title="Copy to clipboard">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <strong><i class="fas fa-lock me-2"></i>Password</strong>
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       class="form-control form-control-lg text-monospace" 
                                       id="password" 
                                       value="{{ credentials.password }}" 
                                       readonly>
                                <button class="btn btn-outline-secondary" 
                                        onclick="togglePassword()"
                                        data-bs-toggle="tooltip" 
                                        title="Show/Hide password">
                                    <i class="fas fa-eye" id="toggleIcon"></i>
                                </button>
                                <button class="btn btn-outline-primary" 
                                        onclick="copyToClipboard('password')"
                                        data-bs-toggle="tooltip" 
                                        title="Copy to clipboard">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">Quick Actions</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-success" onclick="copyAllCredentials()">
                                    <i class="fas fa-copy me-2"></i>Copy All Credentials
                                </button>
                                <button class="btn btn-info" onclick="downloadCredentials()">
                                    <i class="fas fa-download me-2"></i>Download as Text
                                </button>
                                <button class="btn btn-warning" onclick="printCredentials()">
                                    <i class="fas fa-print me-2"></i>Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connection Instructions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        How to Connect
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-desktop me-2"></i>Winbox</h6>
                            <ol class="small">
                                <li>Open Winbox application</li>
                                <li>Enter IP: <code>{{ wan_ip }}</code></li>
                                <li>Username: <code>{{ credentials.username }}</code></li>
                                <li>Password: <code>{{ credentials.password }}</code></li>
                                <li>Click Connect</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-terminal me-2"></i>SSH</h6>
                            <div class="bg-dark text-light p-3 rounded">
                                <code>ssh {{ credentials.username }}@{{ wan_ip }}</code>
                            </div>
                            <small class="text-muted">Then enter the password when prompted</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between">
                <div>
                    <a href="/" class="btn btn-outline-primary">
                        <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                    </a>
                    <a href="/my-requests" class="btn btn-outline-info">
                        <i class="fas fa-history me-2"></i>View All Requests
                    </a>
                </div>
                <div>
                    <a href="/request-credentials" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Request New Credentials
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style media="print">
    .btn, .navbar, .footer, .card-header { display: none !important; }
    .card { border: 2px solid #000 !important; }
    .alert { border: 1px solid #000 !important; }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Countdown using server-provided UTC timestamps
document.addEventListener('DOMContentLoaded', function() {
    const createdRaw = '{{ created_at }}';
    const expiresRaw = '{{ expires_at }}';

    function parseDbDate(value) {
        if (!value) return null;
        // Normalize 'YYYY-MM-DD HH:MM:SS[.ffffff]' to ISO and append Z if no TZ
        let iso = value.trim().replace(' ', 'T');
        iso = iso.replace(/\.(\d{3})\d+/, '.$1');
        if (!/(Z|[\+\-]\d{2}:?\d{2})$/.test(iso)) iso += 'Z';
        return new Date(iso);
    }

    const createdDate = parseDbDate(createdRaw) || new Date();
    const expiresDate = parseDbDate(expiresRaw) || new Date(createdDate.getTime() + {{ duration }} * 60000);

    function updateCountdown() {
        const now = new Date();
        const timeLeft = expiresDate - now;
        const el = document.getElementById('countdown');
        if (timeLeft <= 0) {
            el.textContent = 'EXPIRED';
            el.className = 'badge bg-danger';
            return;
        }
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        el.textContent = `${minutes}m ${seconds}s`;
        if (minutes < 5) {
            el.className = 'badge bg-danger';
        } else if (minutes < 15) {
            el.className = 'badge bg-warning';
        } else {
            el.className = 'badge bg-success';
        }
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);
});

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const textToCopy = element?.value || element?.textContent || '';
    if (!textToCopy) {
        showAlert('Nothing to copy', 'warning');
        return;
    }

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy)
            .then(() => showCopySuccess(element))
            .catch(() => fallbackCopyText(textToCopy, element));
    } else {
        fallbackCopyText(textToCopy, element);
    }
}

function fallbackCopyText(text, elementForFeedback) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.setAttribute('readonly', '');
    textarea.style.position = 'fixed';
    textarea.style.left = '-9999px';
    textarea.style.top = '-9999px';
    document.body.appendChild(textarea);

    let success = false;
    try {
        textarea.select();
        textarea.setSelectionRange(0, textarea.value.length);
        success = document.execCommand('copy');
    } catch (_) {
        success = false;
    } finally {
        document.body.removeChild(textarea);
    }

    if (success) {
        showCopySuccess(elementForFeedback || document.body);
    } else {
        showAlert('Copy failed. Please select and press Ctrl+C.', 'warning');
    }
}

function showCopySuccess(element) {
    const button = element?.parentElement?.querySelector('.btn-outline-primary');
    if (button) {
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        setTimeout(() => { button.innerHTML = originalIcon; }, 1000);
    }
    showAlert('Copied to clipboard!', 'success');
}

function togglePassword() {
    const passwordField = document.getElementById('password');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordField.type = 'password';
        toggleIcon.className = 'fas fa-eye';
    }
}

function copyAllCredentials() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const text = `MikroTik Credentials for {{ wan_ip }}
Username: ${username}
Password: ${password}
Expires: ${document.getElementById('expiresTime').textContent}
Purpose: {{ purpose }}`;
    
    // Try modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showAlert('All credentials copied to clipboard!', 'success');
        }).catch(() => {
            // Fallback method
            fallbackCopyText(text);
        });
    } else {
        // Fallback method
        fallbackCopyText(text);
    }
}

function fallbackCopyText(text) {
    // Create temporary textarea
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    
    try {
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showAlert('All credentials copied to clipboard!', 'success');
    } catch (err) {
        showAlert('Copy failed. Please manually select and copy the credentials.', 'warning');
    } finally {
        document.body.removeChild(textarea);
    }
}

function downloadCredentials() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const content = `MikroTik Temporary Credentials
================================

Device IP: {{ wan_ip }}
Username: ${username}
Password: ${password}
Duration: {{ duration }} minutes
Created: ${document.getElementById('createdTime').textContent}
Expires: ${document.getElementById('expiresTime').textContent}
Purpose: {{ purpose }}

Connection Instructions:
- Winbox: Use IP {{ wan_ip }} with above credentials
- SSH: ssh ${username}@{{ wan_ip }}

SECURITY NOTICE:
- These credentials are temporary and will expire automatically
- Use only for the stated purpose
- All activities are logged and monitored

Generated by MikroTik Credential Manager
`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mikrotik-credentials-${username}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showAlert('Credentials downloaded!', 'success');
}

function printCredentials() {
    window.print();
}
</script>
{% endblock %}